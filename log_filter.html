{% extends "base.html" %}

{% block javascript %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-zh_TW.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{#<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">#}
{% if messages %}
  <div id="messages">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}" style="background-color: #f8d7da; color: #721c24; font-size: 18px; font-weight: bold;">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  <script>
    setTimeout(function () {
      const messages = document.getElementById('messages');
      if (messages) {
        messages.style.transition = 'opacity 1s';
        messages.style.opacity = '0';
        setTimeout(() => messages.remove(), 1000);
      }
    }, 5000); // È°ØÁ§∫ 5 Áßí
  </script>
{% endif %}


<script>
    // È°ØÁ§∫È°èËâ≤‰∏¶Êõ¥Êñ∞È°èËâ≤ÂêçÁ®±ÁöÑÂáΩÊï∏
    function updateColorDisplay(selectElement) {
        // Áç≤ÂèñÈÅ∏ÊìáÁöÑÈ°èËâ≤ÂÄº
        var colorValue = selectElement.value;

        // Ë®≠ÁΩÆÂ∑≤ÈÅ∏‰∏≠ÁöÑÈ°èËâ≤
        selectElement.style.color = colorValue; // Ë®≠ÁΩÆÈÅ∏ÊìáÊ°ÜÁöÑÈ°èËâ≤ÁÇ∫ÊâÄÈÅ∏È°èËâ≤

        // Ë®≠ÁΩÆÊØèÂÄãÈÅ∏È†ÖÁöÑÈ°èËâ≤
        var options = selectElement.options;
        for (var i = 0; i < options.length; i++) {
            // ÂßãÁµÇ‰øùÊåÅÈÅ∏È†ÖÈ°èËâ≤ÁÇ∫ÊâÄÈÅ∏È°èËâ≤
            options[i].style.color = options[i].value;  // Ë®≠ÁΩÆÊØèÂÄãÈÅ∏È†ÖÈ°èËâ≤ÁÇ∫Ë©≤ÈÅ∏È†ÖÁöÑÈ°èËâ≤
            options[i].style.backgroundColor = 'white'; // ËÉåÊôØÈ°èËâ≤ÂßãÁµÇÁÇ∫ÁôΩËâ≤
        }

        // Êõ¥Êñ∞ÈÅ∏ÊìáÊ°ÜÁ∏ÆËµ∑‰æÜÂæåÁöÑÈ°èËâ≤
        selectElement.querySelector('option:selected').style.color = colorValue;
    }
    function clearAll() {
        // Ê∏ÖÈô§ÊâÄÊúâÊñáÂ≠óËº∏ÂÖ•Ê°Ü
        document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');

        // Ê∏ÖÈô§ÊâÄÊúâ‰∏ãÊãâÈÅ∏ÂñÆÔºàÈáçË®≠ÁÇ∫Á¨¨‰∏ÄÂÄãÈÅ∏È†ÖÔºâ
        document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);

        // Ê∏ÖÈô§ÊâÄÊúâ checkboxÔºà‰æãÂ¶Ç enableÔºâ
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);

        // Ëã•Êúâ color-select È°ûÂûãÂÖÉÁ¥†ÈúÄË¶ÅÈ°çÂ§ñËôïÁêÜÈ°ØÁ§∫
        document.querySelectorAll('.color-select').forEach(sel => updateColorDisplay(sel));
    }

    document.addEventListener('DOMContentLoaded', function () {
      $('.selectpicker').selectpicker('render');

      document.body.addEventListener('click', function (e) {
        if (e.target.classList.contains('delete-filter-btn')) {
          e.stopPropagation();

          // üö® ÊäìÂèñ descriptionÔºàÂæûÂâç‰∏ÄÂÄãÂÖÑÂºüÂÖÉÁ¥† .filter-labelÔºâ
          const descriptionSpan = e.target.previousElementSibling;
          const description = descriptionSpan?.textContent?.trim();

          if (!description) {
            alert("‚ùå Can not get description!!!");
            return;
          }

          if (!confirm(`Are you sure you want to delete the filter„Äå${description}„ÄçÔºü`)) return;

          console.log("üöÄ Ê∫ñÂÇôÂà™Èô§ÊèèËø∞ÁÇ∫Ôºö", description);

          fetch("{% url 'delete_filter_config' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `description=${encodeURIComponent(description)}`
          }).then(response => response.json()).then(data => {
            if (data.status === "success") {
              alert("‚úÖ Successfully deleted!");
              {#location.reload();  // ‚úÖ Áõ¥Êé•ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢#}
              {#window.location.href = "{% url 'Log_Filter' %}";#}
              if (data.next_config_id) {
                window.location.href = "{% url 'Log_Filter' %}?config_id=" + data.next_config_id;
              } else {
                window.location.href = "{% url 'Log_Filter' %}";
              }
            } else {
              alert("‚ùå Delete failed:" + data.message);
            }
          });
        }
      });
    });
</script>

{% endblock %}
{% block content %}
    <style>
    /* Ë™øÊï¥Ë°®Ê†º header ÁöÑÂ≠óÈ´îÂ§ßÂ∞èËàáÁΩÆ‰∏≠ */
    table th {
        font-size: 12px;
        text-align: center;
        vertical-align: middle !important;
    }

    /* Ë°®Ê†ºÂÖßÂÆπÊ¨Ñ‰ΩçÔºàÂåÖÂê´ index„ÄÅenable„ÄÅcolor Á≠âÔºâÁΩÆ‰∏≠Â∞çÈΩä */
    table td {
        font-size: 12px;
        text-align: center;
        vertical-align: middle !important;
    }

    /* ÈáùÂ∞ç keyword Ê¨Ñ‰ΩçÂÖßÈÉ®Ëº∏ÂÖ•ÂçÄÁ∂≠ÊåÅ inline ÁöÑÊ®£Âºè */
    .keyword-cell {
        text-align: left;
    }

    .filter-option-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .filter-label {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .delete-filter-btn {
        color: red;
        font-weight: bold;
        cursor: pointer;
        padding-left: 10px;
    }

    .delete-filter-btn:hover {
        color: darkred !important;
        text-decoration: underline;
    }
    .modal-backdrop {
      background-color: #000;
      opacity: 0.5;
    }

</style>

<div class="container-fluid" style="width: auto; max-width: none;">
    <div class="row justify-content-md-center text-center">
        <h1 id="form-title"><strong>Log Filter</strong></h1>
    </div>
    <!-- Âä†Âú® Page 1 Ë°®ÂñÆÈñãÈ†≠ÁöÑ‰ΩçÁΩÆ -->
    <script>
        function loadSavedConfig(selectElement) {
            const configId = selectElement.value;
            console.log('Selected Config ID:', configId);  // Âä†ÂÖ•ÈÄôË°å‰æÜÊ™¢Êü•ÊòØÂê¶ÊúâÊ≠£Á¢∫Áç≤ÂèñÂà∞ configId
            if (configId) {
                window.location.href = `/Log_Filter/Load_Config/${configId}/`;
                window.location.href = `/Log_Filter/?config_id=${configId}`;

            }
        }
    </script>
    <!-- Á¨¨2ÂÄã formÔºöÈÅ∏Ê™îÊ°à + ÊôÇÈñìÂçÄÈñì + ÁØ©ÈÅ∏Ê¢ù‰ª∂ÈÄÅÂá∫ -->
    <form action="/Log_Filter/" method="POST" id="v-method-form" class="form-horizontal" onsubmit="startProgress()">
        {% csrf_token %}
        <div class="row mb-3" style="display: flex; flex-wrap: nowrap; gap: 15px;">
{#        <div class="row mb-3" style="display: flex; flex-wrap: nowrap; gap: 15px; background-color: rgba(255, 230, 180, 0.4); ">#}
          <!-- Â∑¶ÈÇäÔºö‰∏ãÊãâÈÅ∏ÂñÆ -->
{#            <div style="text-align: left; max-width: 300px;">#}
            <div class="col" style="min-width: 300px;">
            <label class="form-label"><strong>Select Saved Filter:</strong></label>
                <div class="input-group">
{#                    <select class="form-select selectpicker w-100" id="saved-configs-select" name="config_id"#}
{#                            data-live-search="true" data-width="100%" onchange="loadSavedConfig(this)"#}
{#                            data-none-selected-text="Ë´ãÈÅ∏Êìá Filter">#}
{#                        {% for config in saved_configs %}#}
{#                            <option value="{{ config.id }}"#}
{#                                    data-content="<div class='filter-option-wrapper'>#}
{#                                                    <span class='filter-label'>{{ config.description }}</span>#}
{#                                                    {% if config.user == request.user %}#}
{#                                                      <span class='delete-filter-btn' title='Âà™Èô§ÈÄôÂÄã Filter'>√ó</span>#}
{#                                                    {% endif %}#}
{#                                                  </div>"#}
{#                                    {% if config.id|stringformat:"s" == request.GET.config_id %}selected{% endif %}>#}
{#                              {{ config.description }}#}
{#                            </option>#}
{#                        {% endfor %}#}
{#                    </select>#}
                    <select class="form-select selectpicker w-100" id="saved-configs-select" name="config_id"
                                    data-live-search="true" data-width="100%"
                                    onchange="handleSavedConfigSelect(this)"
                                    data-none-selected-text="Please select filter">

                        {% for config in saved_configs|slice:":10" %}
                            <option value="{{ config.id }}"
                                    data-content="<div class='filter-option-wrapper'>
                                                    <span class='filter-label'>{{ config.description }}</span>
                                                    {% if config.user == request.user %}
                                                      <span class='delete-filter-btn' title='Delete this filter'>√ó</span>
                                                    {% endif %}
                                                  </div>"
                                    {% if config.id|stringformat:"s" == request.GET.config_id %}selected{% endif %}>
                                {{ config.description }}
                            </option>
                        {% endfor %}
                        {% if saved_configs|length > 5 %}
                            <option value="show_modal">Show All Filter Setting...</option>
                        {% endif %}
                    </select>

        {#                    {% for config in saved_configs %}#}
        {#                        {% if config.id|stringformat:"s" == request.GET.config_id and config.user == request.user %}#}
        {#                            <button class="btn btn-danger" type="submit"#}
        {#                                    onclick="return confirm('‰Ω†Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË®≠ÂÆöÂóéÔºü')">Delete</button>#}
        {#                        {% endif %}#}
        {#                    {% endfor %}#}
                    <button type="button" class="btn btn-warning" onclick="clearAll()">Clear All</button>
                </div>
            </div>
            <!-- Select Log File -->
            <div class="col" style="min-width: 220px;">
                <label class="form-label"><strong>Select Log File:</strong></label>
                    <select class="form-select selectpicker"
                          name="custom_name"
                          data-live-search="true"
                          data-none-selected-text="Ë´ãÈÅ∏Êìá Log File"
                          data-width="100%">
                    {% for log in uploaded_logs %}
                        <option value="{{ log.custom_name }}"
                                {% if log.custom_name == request.session.custom_name %}selected{% endif %}>
                          {{ log.custom_name }}
                        </option>
                    {% endfor %}
                    </select>
            </div>

            <!-- Start Time -->
            <div class="col" style="min-width: 200px;">
                <label class="form-label"><strong>Start Time (From):</strong></label>
                <input type="datetime-local" class="form-control" name="start_time" value="{{ start_time_str }}">
            </div>

            <!-- End Time -->
            <div class="col" style="min-width: 200px;">
                <label class="form-label"><strong>End Time (To):</strong></label>
                <input type="datetime-local" class="form-control" name="end_time" value="{{ end_time_str }}">
            </div>

            <!-- Save Filter + Public Checkbox -->
            <div class="col"
                 style="min-width: 100px;
                        max-width: 150px;
                        margin-left: auto;
                        text-align: left;
                        display: flex;
                        flex-direction: column;
                        justify-content: flex-end;">
                <label><input type="checkbox" id="is_public_checkbox"> Public Setting</label>
                <button type="button" id="save-filter-btn" class="btn btn-success mt-1">Save Setting</button>
            </div>
        </div>

        <!-- Page 1 È°ØÁ§∫ÂÖßÂÆπ -->
        <div id="page1" class="page-content">
            <div class="table-responsive keyword-container">
                <table class="table table-bordered table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Index</th>
                            <th>Enable</th>
                            <th>Color</th>
                            <th>Keyword 1</th>
                            <th>Keyword 2</th>
                            <th>Keyword 3</th>
                            <th>Keyword 4</th>
                            <th>Keyword 5</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for index, form in formset %}
                            {% if index == 41 %}
                                <!-- Âä†ÂÖ•ÂçÄÈöîÁ∑ö -->
                                <tr>
                                    <td colspan="8">
                                        <hr style="border: 2px dashed #999; margin: 8px 0;">
{#                                        <div style="text-align: center; color: #555;"><strong>‰∏ãÊñπÊ¢ù‰ª∂‰ΩøÁî® AND ÈÇèËºØ</strong></div>#}
                                    </td>
                                </tr>
                            {% endif %}
                        <tr>
                            <td>{{ index }}</td>
                            <td class="text-center" id="{{ form.prefix }}-enable">{{ form.enable }}</td>
                            <td>
                                <select class="form-control color-select" name="{{ form.prefix }}-color" onchange="updateColorDisplay(this)">
                                    {% for value, label in form.color.field.choices %}
                                    <option value="{{ value }}" {% if form.color.value == value %}selected{% endif %}
                                        style="
                                            {% if '_bg' in value %}
                                                background-color: {{ value|slice:':-3' }};
                                                color: black;
                                            {% else %}
                                                color: {{ value }};
                                                background-color: white;
                                            {% endif %}
                                        ">
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td class="keyword-cell">
                                <div style="display: inline-block; width: 60px;">
                                    {{ form.keyword_1_type }}  <!-- ÈªëÂêçÂñÆ/ÁôΩÂêçÂñÆÈÅ∏ÊìáÊ°Ü -->
                                </div>
                                <div style="display: inline-block; width: calc(100% - 60px - 5px);">
                                    {{ form.keyword_1 }}  <!-- ÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü -->
                                </div>
                            </td>
                            <td class="keyword-cell">
                                <div style="display: inline-block; width: 60px;">
                                    {{ form.keyword_2_type }}  <!-- ÈªëÂêçÂñÆ/ÁôΩÂêçÂñÆÈÅ∏ÊìáÊ°Ü -->
                                </div>
                                <div style="display: inline-block; width: calc(100% - 60px - 5px);">
                                    {{ form.keyword_2 }}  <!-- ÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü -->
                                </div>
                            </td>
                            <td class="keyword-cell">
                                <div style="display: inline-block; width: 60px;">
                                    {{ form.keyword_3_type }}  <!-- ÈªëÂêçÂñÆ/ÁôΩÂêçÂñÆÈÅ∏ÊìáÊ°Ü -->
                                </div>
                                <div style="display: inline-block; width: calc(100% - 60px - 5px);">
                                    {{ form.keyword_3 }}  <!-- ÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü -->
                                </div>
                            </td>

                            <td class="keyword-cell">
                                <div style="display: inline-block; width: 60px;">
                                    {{ form.keyword_4_type }}  <!-- ÈªëÂêçÂñÆ/ÁôΩÂêçÂñÆÈÅ∏ÊìáÊ°Ü -->
                                </div>
                                <div style="display: inline-block; width: calc(100% - 60px - 5px);">
                                    {{ form.keyword_4 }}  <!-- ÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü -->
                                </div>
                            </td>
                            <td class="keyword-cell">
                                <div style="display: inline-block; width: 60px;">
                                    {{ form.keyword_5_type }}  <!-- ÈªëÂêçÂñÆ/ÁôΩÂêçÂñÆÈÅ∏ÊìáÊ°Ü -->
                                </div>
                                <div style="display: inline-block; width: calc(100% - 60px - 5px);">
                                    {{ form.keyword_5 }}  <!-- ÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü -->
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ÂÖ±Áî®ÁöÑÈÄÅÂá∫ÊåâÈàï -->
        <div class="text-center" style="margin-top: 20px;">
            <button type="submit" class="btn btn-success">Submit</button>
        </div>
    </form>
    <!-- Êñ∞Â¢ûÈÄ≤Â∫¶Ê¢ù Modal -->
    <div id="filterProgressModal" class="modal" tabindex="-1" role="dialog" style="display: none;">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Filtering in Progress</h5>
          </div>
          <div class="modal-body">
            <div id="filter-status-text" style="font-weight: bold;">Initializing...</div>
            <div class="progress">
              <div id="filter-progress-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%;"
                   aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                0%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

<script>
  function startProgress() {
    const modal = document.getElementById("filterProgressModal");
    modal.style.display = "block";
    document.getElementById("filter-status-text").textContent = "Processing...";
    document.getElementById("filter-progress-bar").style.width = "0%";
    document.getElementById("filter-progress-bar").textContent = "0%";
    pollFilterProgress();
  }

  function pollFilterProgress() {
    const interval = setInterval(() => {
      fetch("/filter_progress_status/")
        .then(res => res.json())
        .then(data => {
          const bar = document.getElementById("filter-progress-bar");
          const text = document.getElementById("filter-status-text");
          bar.style.width = `${data.progress}%`;
          bar.setAttribute("aria-valuenow", data.progress);
          bar.textContent = `${data.progress}%`;
          text.textContent = data.status;

          if (data.progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                window.location.href = "{% url 'filtered_log_view' %}"
            }, 1500);

          }
        })
        .catch(err => {
          console.error("Progress fetch failed", err);
        });
    }, 2000);
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('save-filter-btn').addEventListener('click', async function () {
        const description = prompt("Please enter descriptionÔºö");
        if (!description) {
            alert("Please enter descriptionÔºÅ");
            return;
        }

        const custom_name = document.querySelector('select[name="custom_name"]').value;
        const start_time = document.querySelector('input[name="start_time"]').value;
        const end_time = document.querySelector('input[name="end_time"]').value;
        const is_public = document.getElementById("is_public_checkbox").checked;

        // ÊäìÊØè‰∏ÄÂàóÁöÑÁØ©ÈÅ∏Ê¢ù‰ª∂
        const filters = [];
        const rows = document.querySelectorAll("tbody tr");
        rows.forEach((row, idx) => {
            const enable = row.querySelector('input[type="checkbox"]')?.checked || false;
            const color = row.querySelector('select[name$="-color"]')?.value;

            const keywordCells = row.querySelectorAll(".keyword-cell");
            const keywords = [];
            keywordCells.forEach(cell => {
                const type = cell.querySelector("select")?.value;
                const word = cell.querySelector("input")?.value;
                keywords.push({ type, word });
            });

            filters.push({
                index: idx + 1,
                enable,
                color,
                keywords
            });
        });

        // Ê∫ñÂÇô POST Ë≥áÊñô
        const payload = {
            description,
            custom_name,
            start_time,
            end_time,
            is_public,
            filters
        };

        const response = await fetch("{% url 'save_filter_from_bottum' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.status === "success") {
            alert("‚úÖ Successfully saved!");
            location.reload();
        } else {
            alert("‚ùå Save failed:" + result.message);
        }
    });
  });
  function handleSavedConfigSelect(select) {
    const configId = select.value;
    console.log("‚ö†Ô∏è ÈÅ∏Âà∞ÁöÑÂÄºÊòØ", configId);
    if (configId === "show_modal") {
        window.location.href = "{% url 'all_filter_settings_view' %}";
        return;
    }

    // ‚úÖ Ê≠£Â∏∏Ë∑≥ËΩâ
    if (configId) {
        window.location.href = `/Log_Filter/?config_id=${configId}`;
    }
  }
  function loadConfigFromModal(configId) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('filterConfigModal'));
    modal.hide();
    window.location.href = `/Log_Filter/?config_id=${configId}`;
  }
  function deleteConfigFromModal(description) {
      if (!confirm(`Are you sure to delete filter „Äå${description}„Äç ?`)) return;

      fetch("{% url 'delete_filter_config' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `description=${encodeURIComponent(description)}`
      }).then(response => response.json()).then(data => {
        if (data.status === "success") {
          alert("‚úÖ Successfully deleted!");
          location.reload();  // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢Âà∑Êñ∞ select Ë∑ü modal ÂàóË°®
        } else {
          alert("‚ùå Delete failed:" + data.message);
        }
      }).catch(err => {
        console.error("‚ùå AJAX error", err);
        alert("‚ùå An error occurred. Cannot delete.");
      });
  }
</script>
</div>
{% endblock %}
